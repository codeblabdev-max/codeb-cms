# vsvs.kr (호불호 커뮤니티) Caddy 설정
# 141.164.60.51 서버 /etc/caddy/Caddyfile에 추가할 설정

# ========================================
# VSVS.KR - 호불호 커뮤니티
# ========================================
vsvs.kr {
    # 애플리케이션 프록시 (localhost:3100)
    reverse_proxy localhost:3100 {
        header_up Host {host}
        header_up X-Real-IP {remote}

        # 헬스체크
        health_uri /api/health
        health_interval 30s
        health_timeout 10s

        # 타임아웃 설정
        transport http {
            dial_timeout 10s
            response_header_timeout 30s
        }
    }

    # 정적 파일 캐싱
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.webp *.avif *.ttf *.eot
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
        Vary "Accept-Encoding"
    }

    # HTML 캐싱 (짧게)
    @html {
        path *.html /
    }
    header @html {
        Cache-Control "public, max-age=3600, must-revalidate"
    }

    # API 요청은 캐싱 안함
    @api {
        path /api/*
    }
    header @api {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
    }

    # 보안 헤더
    header {
        # XSS 보호
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"

        # 레퍼러 정책
        Referrer-Policy "strict-origin-when-cross-origin"

        # 권한 정책
        Permissions-Policy "geolocation=(), microphone=(), camera=()"

        # HSTS (1년, 서브도메인 포함)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

        # 서버 정보 숨기기
        -Server
        -X-Powered-By
    }

    # Gzip 압축
    encode {
        gzip 6
        match {
            header Content-Type text/*
            header Content-Type application/json*
            header Content-Type application/javascript*
            header Content-Type application/xml*
            header Content-Type application/x-javascript*
        }
    }

    # 로그 설정
    log {
        output file /var/log/caddy/vsvs.kr.log {
            roll_size 100mb
            roll_keep 10
            roll_keep_for 30d
        }
        format json
    }

    # 에러 페이지
    handle_errors {
        @5xx expression {http.error.status_code} >= 500
        respond @5xx "서비스 일시 중단. 잠시 후 다시 시도해주세요." 500

        @404 expression {http.error.status_code} == 404
        respond @404 "페이지를 찾을 수 없습니다." 404
    }
}

# WWW 리다이렉트
www.vsvs.kr {
    redir https://vsvs.kr{uri} permanent
}

# API 서브도메인 (필요시)
api.vsvs.kr {
    reverse_proxy localhost:3100 {
        header_up Host vsvs.kr
        header_up X-Real-IP {remote}
    }

    # API는 캐싱 안함
    header {
        Cache-Control "no-cache, no-store, must-revalidate"
        -Server
    }

    encode gzip

    log {
        output file /var/log/caddy/api.vsvs.kr.log
        format json
    }
}

# 관리자 패널 (선택사항)
admin.vsvs.kr {
    # IP 화이트리스트 (필요시 활성화)
    # @allowed {
    #     remote_ip 141.164.60.0/24
    #     remote_ip YOUR_OFFICE_IP
    # }

    reverse_proxy localhost:3100 {
        header_up Host vsvs.kr
        header_up X-Real-IP {remote}
    }

    # Basic Auth (필요시 활성화)
    # basicauth {
    #     admin JDJhJDE0JHlvdXJfaGFzaGVkX3Bhc3N3b3JkX2hlcmU
    # }

    header {
        Cache-Control "no-cache, no-store, must-revalidate"
        -Server
    }

    log {
        output file /var/log/caddy/admin.vsvs.kr.log
        format json
    }
}
